<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Star Wars TD with Store</title>
  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
    }

    /* Home Screen */
    #homeScreen {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      flex-grow: 1;
      width: 100%;
      background: #111;
    }

    #homeScreen h1 {
      font-size: 3em;
      margin-bottom: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #ffe81f; /* Star Wars yellow */
      text-shadow: 0 0 10px #ffe81f;
    }

    #startBtn {
      font-size: 24px;
      padding: 15px 40px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background: #007bff;
      color: white;
      transition: background-color 0.3s ease;
      box-shadow: 0 0 10px #007bff;
    }
    #startBtn:hover {
      background: #0056b3;
      box-shadow: 0 0 20px #0056b3;
    }

    /* Hide home screen when game started */
    body.game-started #homeScreen {
      display: none;
    }

    /* Game UI and Canvas Container */
    #gameContainer {
      display: flex;
      width: 100%;
      max-width: 1100px;
      gap: 15px;
      padding: 10px;
      box-sizing: border-box;
    }

    /* Left side: Game + UI */
    #gameSide {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    #ui {
      display: flex;
      width: 100%;
      justify-content: space-between;
      background: #111;
      padding: 10px;
      box-sizing: border-box;
      margin-bottom: 10px;
      user-select: none;
    }
    #towerPanel {
      display: flex;
      gap: 10px;
    }
    .tower-icon {
      width: 60px;
      height: 60px;
      border: 2px solid #555;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-size: 12px;
      text-align: center;
      white-space: pre-line;
      user-select: none;
    }
    #gameCanvas {
      background: #222;
      border: 4px solid #555;
      display: block;
      margin: 0 auto;
      cursor: crosshair;
    }
    #upgradePanel {
      background: #222;
      padding: 10px;
      margin-top: 10px;
      width: 200px;
      border: 2px solid #555;
      display: none;
      flex-direction: column;
      gap: 5px;
      user-select: none;
    }
    #upgradePanel button {
      padding: 5px;
      cursor: pointer;
      background: #444;
      border: none;
      color: white;
      font-size: 14px;
      border-radius: 4px;
      transition: background-color 0.3s ease;
    }
    #upgradePanel button:disabled {
      background: #222;
      color: #777;
      cursor: not-allowed;
    }
    #upgradePanel button:hover:not(:disabled) {
      background: #666;
    }
    #nextWaveBtn {
      margin-top: 10px;
      padding: 8px 16px;
      font-size: 16px;
      background: #007bff;
      border: none;
      color: white;
      cursor: pointer;
      border-radius: 4px;
      user-select: none;
      transition: background-color 0.3s ease;
      align-self: center;
    }
    #nextWaveBtn:disabled {
      background: #004a99;
      cursor: not-allowed;
    }
    #nextWaveBtn:hover:not(:disabled) {
      background: #0056b3;
    }

    /* STORE PANEL */
    #storePanel {
      width: 250px;
      background: #111;
      border: 2px solid #555;
      padding: 10px;
      box-sizing: border-box;
      user-select: none;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    #storePanel h2 {
      margin-top: 0;
      text-align: center;
      color: #ffe81f;
      text-shadow: 0 0 6px #ffe81f;
    }
    .store-item {
      background: #222;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #555;
      text-align: center;
    }
    .store-item button {
      margin-top: 8px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background: #007bff;
      color: white;
      transition: background-color 0.3s ease;
    }
    .store-item button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <!-- HOME SCREEN -->
  <div id="homeScreen">
    <h1>Star Wars Tower Defense</h1>
    <button id="startBtn">Start Game</button>
  </div>

  <!-- GAME CONTAINER -->
  <div id="gameContainer" style="display:none;">
    <div id="gameSide">
      <div id="ui">
        <div id="towerPanel"></div>
        <div id="goldDisplay">Gold: 100</div>
      </div>

      <canvas id="gameCanvas" width="800" height="500"></canvas>

      <button id="nextWaveBtn" style="display:none;">Play Next Wave</button>

      <div id="upgradePanel">
        <div id="upgradeInfo"></div>
        <button id="upgradeDamageBtn">Upgrade Damage (Cost: 50)</button>
        <button id="upgradeFireRateBtn">Upgrade Fire Rate (Cost: 50)</button>
      </div>
    </div>

    <div id="storePanel">
      <h2>Store</h2>

      <div class="store-item">
        <strong>Gold Pack +100</strong><br />
        <button id="buyGoldBtn">Buy for $0.99</button>
      </div>

      <div class="store-item">
        <strong>Shield Booster</strong><br />
        <small>Protect towers for 30 sec</small><br />
        <button id="buyShieldBtn">Buy for 150 Gold</button>
      </div>
    </div>
  </div>

  <script>
    // DOM elements
    const homeScreen = document.getElementById("homeScreen");
    const startBtn = document.getElementById("startBtn");
    const gameContainer = document.getElementById("gameContainer");
    const ui = document.getElementById("ui");
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const towerPanel = document.getElementById("towerPanel");
    const goldDisplay = document.getElementById("goldDisplay");
    const upgradePanel = document.getElementById("upgradePanel");
    const upgradeInfo = document.getElementById("upgradeInfo");
    const upgradeDamageBtn = document.getElementById("upgradeDamageBtn");
    const upgradeFireRateBtn = document.getElementById("upgradeFireRateBtn");
    const nextWaveBtn = document.getElementById("nextWaveBtn");

    const buyGoldBtn = document.getElementById("buyGoldBtn");
    const buyShieldBtn = document.getElementById("buyShieldBtn");

    // Game variables
    let gold = 100;
    let selectedTowerType = null;
    let selectedTower = null;
    const tileSize = 40;
    const pathY = 240;

    let shieldActive = false;
    let shieldTimeout;

    // Character / Tower options
    const characters = [
      { name: "Luke", color: "green", cost: 0, fireRate: 30, damage: 1, range: 100 },
      { name: "Anakin", color: "blue", cost: 0, fireRate: 60, damage: 2, range: 110 },
      { name: "Obi-Wan", color: "beige", cost: 75, fireRate: 90, damage: 4, range: 120 },
      { name: "Yoda", color: "lime", cost: 100, fireRate: 20, damage: 3, range: 130 },
      { name: "Darth Vader", color: "red", cost: 125, fireRate: 80, damage: 5, range: 110 },
      { name: "Rey", color: "cyan", cost: 90, fireRate: 50, damage: 3, range: 100 }
    ];

    const towers = [], enemies = [], bullets = [];

    // Update gold display UI
    function updateGoldDisplay() {
      goldDisplay.innerText = `Gold: ${gold}`;
    }

    // Create tower selection buttons
    function createTowerPanel() {
      towerPanel.innerHTML = ""; // clear first
      characters.forEach(char => {
        const btn = document.createElement("div");
        btn.classList.add("tower-icon");
        btn.style.background = char.color;
        btn.innerText = `${char.name}\n(${char.cost})`;
        btn.onclick = () => {
          if (gold >= char.cost) {
            selectedTowerType = char;
            selectedTower = null;
            upgradePanel.style.display = "none";
          } else {
            alert("Not enough gold!");
          }
        };
        towerPanel.appendChild(btn);
      });
    }

    // Tower class
    class Tower {
      constructor(x, y, data) {
        this.x = x;
        this.y = y;
        this.data = {...data};
        this.cooldown = 0;
        this.upgradeLevelDamage = 0;
        this.upgradeLevelFireRate = 0;
      }
      draw() {
        ctx.fillStyle = this.data.color;
        ctx.fillRect(this.x, this.y, tileSize, tileSize);
        ctx.fillStyle = "white";
        ctx.font = "10px sans-serif";
        ctx.fillText(this.data.name, this.x + 2, this.y + tileSize + 10);
        if (shieldActive) {
          ctx.strokeStyle = "cyan";
          ctx.lineWidth = 3;
          ctx.strokeRect(this.x - 3, this.y - 3, tileSize + 6, tileSize + 6);
        }
      }
      update() {
        if (this.cooldown > 0) this.cooldown--;
        // Attack logic
        if (this.cooldown === 0) {
          // Find enemy in range
          const target = enemies.find(e => {
            const dx = e.x - this.x;
            const dy = e.y - this.y;
            return Math.sqrt(dx * dx + dy * dy) <= this.data.range;
          });
          if (target) {
            this.shoot(target);
            this.cooldown = Math.max(10, this.data.fireRate - this.upgradeLevelFireRate * 10);
          }
        }
      }
      shoot(enemy) {
        const bullet = new Bullet(this.x + tileSize / 2, this.y + tileSize / 2, enemy, this.data.damage + this.upgradeLevelDamage);
        bullets.push(bullet);
      }
    }

    // Enemy class
    class Enemy {
      constructor() {
        this.x = 0;
        this.y = pathY;
        this.speed = 1 + wave * 0.2;
        this.health = 20 + wave * 10;
        this.maxHealth = this.health;
      }
      update() {
        this.x += this.speed;
      }
      draw() {
        ctx.fillStyle = "red";
        ctx.fillRect(this.x, this.y, tileSize, tileSize);
        // Health bar
        ctx.fillStyle = "black";
        ctx.fillRect(this.x, this.y - 6, tileSize, 4);
        ctx.fillStyle = "lime";
        const healthWidth = (this.health / this.maxHealth) * tileSize;
        ctx.fillRect(this.x, this.y - 6, healthWidth, 4);
      }
    }

    // Bullet class
    class Bullet {
      constructor(x, y, target, damage) {
        this.x = x;
        this.y = y;
        this.target = target;
        this.damage = damage;
        this.speed = 5;
      }
      update() {
        if (!this.target) return;
        const dx = this.target.x + tileSize/2 - this.x;
        const dy = this.target.y + tileSize/2 - this.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < this.speed) {
          this.target.health -= this.damage;
          // Remove bullet
          const index = bullets.indexOf(this);
          if (index > -1) bullets.splice(index, 1);
          return;
        }
        this.x += (dx / dist) * this.speed;
        this.y += (dy / dist) * this.speed;
      }
      draw() {
        ctx.fillStyle = "yellow";
        ctx.beginPath();
        ctx.arc(this.x, this.y, 4, 0, 2 * Math.PI);
        ctx.fill();
      }
    }

    // Place tower on canvas click
    canvas.addEventListener("click", e => {
      const rect = canvas.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const clickY = e.clientY - rect.top;

      // Don't allow placing on path (pathY to pathY + tileSize)
      if (clickY > pathY && clickY < pathY + tileSize) return;

      // Snap to grid
      const gridX = Math.floor(clickX / tileSize) * tileSize;
      const gridY = Math.floor(clickY / tileSize) * tileSize;

      // Check if tower already exists there
      if (towers.find(t => t.x === gridX && t.y === gridY)) return;

      if (selectedTowerType && gold >= selectedTowerType.cost) {
        gold -= selectedTowerType.cost;
        updateGoldDisplay();
        const newTower = new Tower(gridX, gridY, selectedTowerType);
        towers.push(newTower);
        selectedTowerType = null;
        upgradePanel.style.display = "none";
      }
    });

    // Select tower to upgrade on click
    canvas.addEventListener("contextmenu", e => {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const clickY = e.clientY - rect.top;

      const gridX = Math.floor(clickX / tileSize) * tileSize;
      const gridY = Math.floor(clickY / tileSize) * tileSize;

      const tower = towers.find(t => t.x === gridX && t.y === gridY);
      if (tower) {
        selectedTower = tower;
        upgradePanel.style.display = "flex";
        upgradeInfo.innerText = `Upgrade ${tower.data.name}\nDamage: ${tower.data.damage + tower.upgradeLevelDamage}\nFire Rate: ${Math.max(10, tower.data.fireRate - tower.upgradeLevelFireRate * 10)}`;
        upgradeDamageBtn.disabled = gold < 50;
        upgradeFireRateBtn.disabled = gold < 50;
      } else {
        upgradePanel.style.display = "none";
        selectedTower = null;
      }
    });

    // Upgrade damage button
    upgradeDamageBtn.onclick = () => {
      if (selectedTower && gold >= 50) {
        gold -= 50;
        selectedTower.upgradeLevelDamage++;
        updateGoldDisplay();
        upgradeInfo.innerText = `Upgrade ${selectedTower.data.name}\nDamage: ${selectedTower.data.damage + selectedTower.upgradeLevelDamage}\nFire Rate: ${Math.max(10, selectedTower.data.fireRate - selectedTower.upgradeLevelFireRate * 10)}`;
        upgradeDamageBtn.disabled = gold < 50;
        upgradeFireRateBtn.disabled = gold < 50;
      }
    };

    // Upgrade fire rate button
    upgradeFireRateBtn.onclick = () => {
      if (selectedTower && gold >= 50) {
        gold -= 50;
        selectedTower.upgradeLevelFireRate++;
        updateGoldDisplay();
        upgradeInfo.innerText = `Upgrade ${selectedTower.data.name}\nDamage: ${selectedTower.data.damage + selectedTower.upgradeLevelDamage}\nFire Rate: ${Math.max(10, selectedTower.data.fireRate - selectedTower.upgradeLevelFireRate * 10)}`;
        upgradeDamageBtn.disabled = gold < 50;
        upgradeFireRateBtn.disabled = gold < 50;
      }
    };

    // Waves
    let wave = 1;
    let spawning = false;

    function spawnWave() {
      spawning = true;
      let enemiesToSpawn = wave * 3;
      let spawnInterval = setInterval(() => {
        if (enemiesToSpawn <= 0) {
          clearInterval(spawnInterval);
          spawning = false;
          wave++;
          nextWaveBtn.style.display = "none";
          return;
        }
        enemies.push(new Enemy());
        enemiesToSpawn--;
      }, 800);
    }

    // Next wave button
    nextWaveBtn.onclick = () => {
      if (!spawning) {
        spawnWave();
        nextWaveBtn.style.display = "none";
      }
    };

    // Game loop
    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Draw path
      ctx.fillStyle = "#654321";
      ctx.fillRect(0, pathY, canvas.width, tileSize);

      // Draw towers
      towers.forEach(t => {
        t.update();
        t.draw();
      });

      // Draw enemies
      for (let i = enemies.length - 1; i >= 0; i--) {
        const enemy = enemies[i];
        enemy.update();
        enemy.draw();

        if (enemy.health <= 0) {
          gold += 10;
          updateGoldDisplay();
          enemies.splice(i, 1);
        } else if (enemy.x > canvas.width) {
          enemies.splice(i, 1);
          // TODO: reduce player health or end game if enemies pass
        }
      }

      // Draw bullets
      bullets.forEach(b => {
        b.update();
        b.draw();
      });

      // Show next wave button if all enemies are dead and wave > 1
      if (enemies.length === 0 && wave > 1 && !spawning) {
        nextWaveBtn.style.display = "inline-block";
        nextWaveBtn.disabled = false;
      }

      requestAnimationFrame(gameLoop);
    }

    // Start game
    startBtn.onclick = () => {
      document.body.classList.add("game-started");
      homeScreen.style.display = "none";
      gameContainer.style.display = "flex";
      updateGoldDisplay();
      createTowerPanel();
      spawnWave();
      gameLoop();
    };

    // STORE BUTTONS

    // Buy Gold (simulate purchase)
    buyGoldBtn.onclick = () => {
      if (confirm("Simulate purchase of 100 gold for $0.99?")) {
        gold += 100;
        updateGoldDisplay();
        alert("Purchase successful! +100 Gold");
      }
    };

    // Buy Shield Booster
    buyShieldBtn.onclick = () => {
      if (gold >= 150) {
        gold -= 150;
        updateGoldDisplay();
        activateShield();
        alert("Shield Booster activated for 30 seconds!");
      } else {
        alert("Not enough gold for Shield Booster!");
      }
    };

    // Shield effect: highlights towers for 30 seconds
    function activateShield() {
      shieldActive = true;
      clearTimeout(shieldTimeout);
      shieldTimeout = setTimeout(() => {
        shieldActive = false;
      }, 30000);
    }
  </script>
</body>
</html>
