<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>F1: Pixel Paddock</title>
<style>
  :root{
    --bg:#0b0f1a; --panel:#121a2b; --accent:#ff2d55; --text:#e9f0ff; --muted:#9bb0ff;
    --good:#3ad17a; --warn:#ffcc00; --bad:#ff6666;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 600px at 50% 0%, #121a2b 0%, #0b0f1a 60%, #05070c 100%);color:var(--text);font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial;}
  #ui{position:fixed;inset:0;display:grid;place-items:center;padding:12px}
  .card{width:min(1100px,95vw);background:linear-gradient(180deg,#151e33 0%, #0f1530 100%);border:1px solid #1d2a4d;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.5);padding:18px}
  h1{margin:0 0 8px;font-size:28px;letter-spacing:.5px}
  h2{margin:14px 0 8px;font-size:20px}
  .row{display:flex;gap:14px;flex-wrap:wrap}
  .col{flex:1 1 300px}
  .btn{background:linear-gradient(180deg,#ff3b6b,#ff0f4d);border:none;color:white;padding:12px 16px;border-radius:10px;font-weight:700;letter-spacing:.4px;cursor:pointer;box-shadow:0 6px 18px rgba(255,45,85,.35);transition:.15s transform}
  .btn:hover{transform:translateY(-2px)}
  .btn.secondary{background:linear-gradient(180deg,#263155,#1c2548);color:#bcd0ff;box-shadow:none;border:1px solid #28335b}
  .btn.ghost{background:transparent;border:1px dashed #384a87;color:#a9b9ff}
  .btn.small{padding:8px 10px;border-radius:8px;font-size:13px}
  .stat{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border:1px solid #253464;border-radius:10px;margin:6px 0;background:#0f1730}
  .progress{height:8px;background:#26335d;border-radius:999px;overflow:hidden;flex:1;margin-left:8px}
  .bar{height:100%;background:linear-gradient(90deg,#3ad17a,#7af2ad)}
  .money{color:var(--good);font-weight:700}
  canvas{display:block;width:100%;height:auto;background:#06080f;border-radius:12px;border:1px solid #142042}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid #2b3a6b;background:#10183a;color:#b7c8ff;font-size:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(180px, 1fr));gap:10px}
  .tile{border:1px solid #263564;background:#0f1730;padding:10px;border-radius:12px}
  .big{font-size:40px;font-weight:800;letter-spacing:1px}
  .kbd{background:#1b2547;border:1px solid #2c3a6e;padding:2px 6px;border-radius:6px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px}
  .footer{opacity:.75;font-size:12px;margin-top:6px}
  .note{color:var(--muted);font-size:13px}
  .muted{color:#a9b4d9}
</style>
</head>
<body>
<div id="ui"></div>
<template id="tpl-menu">
  <div class="card">
    <h1>F1: <span style="color:var(--accent)">Pixel Paddock</span></h1>
    <div class="row">
      <div class="col">
        <p class="muted">Build your team, pick a tire strategy, and race in lane-based, arcade action inspired by retro sports sims.</p>
        <div class="grid">
          <div class="tile">
            <h2>Career</h2>
            <p>Season race with cash & points. Upgrade your car to compete for the title.</p>
            <button class="btn" data-action="career">Start Career Race</button>
          </div>
          <div class="tile">
            <h2>Quick Race</h2>
            <p>Jump straight into a 3-lap sprint with basic spec.</p>
            <button class="btn secondary" data-action="quick">Quick Race</button>
          </div>
          <div class="tile">
            <h2>Garage</h2>
            <p>Spend prize money on performance.</p>
            <button class="btn secondary" data-action="garage">Open Garage</button>
          </div>
        </div>
        <p class="footer">Controls: <span class="kbd">←</span>/<span class="kbd">→</span> lanes · <span class="kbd">Space</span> ERS · <span class="kbd">P</span> Pit · <span class="kbd">M</span> Mute</p>
      </div>
      <div class="col">
        <canvas id="preview" width="520" height="360"></canvas>
      </div>
    </div>
  </div>
</template>

<template id="tpl-garage">
  <div class="card">
    <h1>Garage & Upgrades</h1>
    <div class="row">
      <div class="col">
        <div class="stat"><span>Bank</span><span class="money" id="bank"></span></div>
        <div class="stat"><span>Engine (Top Speed)</span><div class="progress"><div id="engineBar" class="bar" style="width:0%"></div></div><button class="btn small" data-upg="engine">+ Upgrade</button></div>
        <div class="stat"><span>Aero (Handling)</span><div class="progress"><div id="aeroBar" class="bar" style="width:0%"></div></div><button class="btn small" data-upg="aero">+ Upgrade</button></div>
        <div class="stat"><span>Pit Crew (Stop Time)</span><div class="progress"><div id="pitBar" class="bar" style="width:0%"></div></div><button class="btn small" data-upg="pitcrew">+ Upgrade</button></div>
        <p class="note">Each upgrade increases performance and cost scales with level.</p>
      </div>
      <div class="col">
        <div class="tile">
          <h2>Season Summary</h2>
          <p>Races: <b id="races"></b></p>
          <p>Points: <b id="points"></b></p>
          <p>Wins: <b id="wins"></b></p>
        </div>
        <div class="tile">
          <button class="btn" data-action="career">Next Career Race</button>
          <button class="btn secondary" data-action="menu">Back to Menu</button>
        </div>
      </div>
    </div>
  </div>
</template>

<template id="tpl-strategy">
  <div class="card">
    <h1>Race Strategy</h1>
    <div class="row">
      <div class="col">
        <h2>Circuit</h2>
        <div id="circuit" class="pill">—</div>
        <p class="muted">Laps: <b id="laps"></b> · Weather: <b id="weather"></b></p>
        <h2>Tires</h2>
        <div class="grid">
          <div class="tile"><h3>Soft</h3><p>Fast but wears quickly.</p><button class="btn small" data-tire="soft">Select Soft</button></div>
          <div class="tile"><h3>Medium</h3><p>Balanced performance.</p><button class="btn small" data-tire="medium">Select Medium</button></div>
          <div class="tile"><h3>Hard</h3><p>Slower but durable.</p><button class="btn small" data-tire="hard">Select Hard</button></div>
          <div class="tile"><h3>Inter</h3><p>For light rain.</p><button class="btn small" data-tire="inter">Select Inter</button></div>
        </div>
        <p class="note">You may pit once to change tires. Pit window opens each time you cross the line.</p>
        <button class="btn" data-action="startRace">Start Race</button>
        <button class="btn secondary" data-action="menu">Cancel</button>
      </div>
      <div class="col">
        <canvas id="raceCanvas" width="520" height="600"></canvas>
      </div>
    </div>
  </div>
</template>

<template id="tpl-results">
  <div class="card">
    <h1>Race Results</h1>
    <div class="row">
      <div class="col">
        <div class="grid" id="resultGrid"></div>
        <p class="note" id="payout"></p>
        <button class="btn" data-action="garage">Go to Garage</button>
        <button class="btn secondary" data-action="career">Next Race</button>
        <button class="btn ghost" data-action="menu">Main Menu</button>
      </div>
      <div class="col">
        <canvas id="summaryCanvas" width="520" height="360"></canvas>
      </div>
    </div>
  </div>
</template>

<script>
(() => {
  // ---------- Persistent State ----------
  const defaultSave = {
    bank: 2000, points: 0, wins: 0, races: 0,
    upgrades: { engine: 1, aero: 1, pitcrew: 1 },
  };
  let save = loadSave();

  function loadSave(){
    try{
      const s = JSON.parse(localStorage.getItem('f1_pp_save') || 'null');
      if(!s) return structuredClone(defaultSave);
      // Backfill
      s.upgrades ??= {engine:1,aero:1,pitcrew:1};
      return s;
    }catch(e){ return structuredClone(defaultSave); }
  }
  function writeSave(){ localStorage.setItem('f1_pp_save', JSON.stringify(save)); }

  // ---------- Audio ----------
  const sfx = {
    click: mkBeep(300, .04),
    coin: mkBeep(660, .06),
    overtake: mkBeep(520, .05),
    bump: mkBeep(140, .06),
    lap: mkBeep(880, .09),
    finish: mkBeep(420, .2),
  };
  let muted = false;
  function play(name){ if(muted) return; sfx[name]?.(); }
  function mkBeep(freq=440, dur=0.08){
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    return ()=> {
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.type='square'; o.frequency.value=freq;
      g.gain.setValueAtTime(.0001, ctx.currentTime);
      g.gain.linearRampToValueAtTime(.08, ctx.currentTime+.01);
      g.gain.exponentialRampToValueAtTime(.0001, ctx.currentTime+dur);
      o.connect(g).connect(ctx.destination);
      o.start(); o.stop(ctx.currentTime+dur+.02);
    };
  }
  window.addEventListener('keydown', e => {
    if(e.key.toLowerCase()==='m'){ muted=!muted; }
  });

  // ---------- DOM helpers ----------
  const $ui = document.getElementById('ui');
  function render(tplId, enhancer){
    $ui.innerHTML='';
    const tpl = document.getElementById(tplId).content.cloneNode(true);
    $ui.appendChild(tpl);
    enhancer?.();
  }
  function fmtMoney(n){ return '$' + n.toLocaleString(); }

  // ---------- Menu / Preview ----------
  function drawPreview(){
    const cv = document.getElementById('preview');
    if(!cv) return;
    const ctx = cv.getContext('2d');
    const w = cv.width, h = cv.height;
    ctx.clearRect(0,0,w,h);
    // Track
    ctx.fillStyle = '#0a0f1a'; ctx.fillRect(0,0,w,h);
    ctx.fillStyle='#111b33'; ctx.fillRect(w*0.15,0,w*0.7,h);
    // Lanes
    ctx.setLineDash([12,12]); ctx.strokeStyle='#5b6ea8'; ctx.lineWidth=3;
    for(let i=1;i<3;i++){
      const x = w*0.15 + (w*0.7/3)*i;
      ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
    }
    ctx.setLineDash([]);
    // Cars (pixel-art F1)
    carSprite(ctx, w*0.25, h*0.75, '#ff3b6b');
    carSprite(ctx, w*0.25 + w*0.7/3, h*0.52, '#3ad17a');
    carSprite(ctx, w*0.25 + 2*w*0.7/3, h*0.30, '#ffd166');
    // Title
    ctx.fillStyle='rgba(255,255,255,.08)'; ctx.font='900 90px system-ui';
    ctx.fillText('F1', w*0.55, 110);
    ctx.fillStyle='#bcd0ff'; ctx.font='700 16px system-ui';
    ctx.fillText('Arcade Career • Lane Racing • ERS • Pit Stops', 20, h-16);
  }

  // ---------- Garage ----------
  function openGarage(){
    render('tpl-garage', () => {
      document.getElementById('bank').textContent = fmtMoney(save.bank);
      const maxLv = 10;
      const pct = lv => Math.min(100, (lv-1)/(maxLv-1)*100);
      document.getElementById('engineBar').style.width = pct(save.upgrades.engine)+'%';
      document.getElementById('aeroBar').style.width = pct(save.upgrades.aero)+'%';
      document.getElementById('pitBar').style.width = pct(save.upgrades.pitcrew)+'%';
      document.getElementById('races').textContent = save.races;
      document.getElementById('points').textContent = save.points;
      document.getElementById('wins').textContent = save.wins;

      $ui.querySelectorAll('[data-upg]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const key = btn.getAttribute('data-upg');
          const lv = save.upgrades[key];
          if(lv>=maxLv){ alert('Max level reached.'); return; }
          const cost = 1500 + Math.floor(Math.pow(lv,2.1)*600);
          if(save.bank < cost){ alert('Not enough funds.\nCost: '+fmtMoney(cost)); return; }
          save.bank -= cost;
          save.upgrades[key]++;
          writeSave();
          play('coin');
          openGarage();
        });
      });
      $ui.querySelector('[data-action="career"]').onclick = ()=> startCareerFlow();
      $ui.querySelector('[data-action="menu"]').onclick = ()=> openMenu();
    });
  }

  // ---------- Strategy / Race Seed ----------
  const circuits = [
    {name:'Monza', laps:4, grip:1.0, straights:1.2},
    {name:'Monaco', laps:4, grip:1.1, straights:0.8},
    {name:'Silverstone', laps:4, grip:1.05, straights:1.05},
    {name:'Spa', laps:4, grip:1.0, straights:1.15},
    {name:'Suzuka', laps:4, grip:1.0, straights:1.0},
  ];
  const weathers = [
    {name:'Clear', wet:0.0, drag:1.0},
    {name:'Cloudy', wet:0.0, drag:0.99},
    {name:'Light Rain', wet:0.5, drag:0.97},
  ];
  const tireDefs = {
    soft:   {base:1.08, wear:0.018, minWet:0.0},
    medium: {base:1.00, wear:0.012, minWet:0.0},
    hard:   {base:0.94, wear:0.008, minWet:0.0},
    inter:  {base:0.92, wear:0.010, minWet:0.3},
  };

  let careerMode = false;
  let currentPlan = null;

  function startCareerFlow(){
    careerMode = true;
    openStrategy();
  }
  function quickRace(){
    careerMode = false;
    openStrategy(true);
  }

  function openStrategy(quick=false){
    const circuit = circuits[Math.floor(Math.random()*circuits.length)];
    // Weather: in quick, bias to clear; in career random
    const weather = quick ? weathers[0] : weathers[Math.floor(Math.random()*weathers.length)];
    const laps = circuit.laps;

    render('tpl-strategy', () => {
      document.getElementById('circuit').textContent = circuit.name;
      document.getElementById('laps').textContent = laps;
      document.getElementById('weather').textContent = weather.name;
      // Preview loop
      const cv = document.getElementById('raceCanvas'), ctx = cv.getContext('2d');
      let t=0; (function loop(){
        if(!cv.isConnected) return;
        t+=0.016; drawRacePreview(ctx, cv.width, cv.height, t); requestAnimationFrame(loop);
      })();

      let chosen='medium';
      $ui.querySelectorAll('[data-tire]').forEach(b=>{
        b.addEventListener('click', ()=>{ chosen=b.getAttribute('data-tire'); play('click'); });
      });
      $ui.querySelector('[data-action="startRace"]').onclick = ()=>{
        currentPlan = { circuit, weather, laps, tire: chosen };
        play('click');
        startRace(currentPlan);
      };
      $ui.querySelector('[data-action="menu"]').onclick = ()=> openMenu();
    });
  }

  function drawRacePreview(ctx,w,h,t){
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle='#0b0f1a'; ctx.fillRect(0,0,w,h);
    const trackX = w*0.1, trackW = w*0.8;
    ctx.fillStyle='#111b33'; ctx.fillRect(trackX,0,trackW,h);
    ctx.setLineDash([10,10]); ctx.strokeStyle='#4e5f95'; ctx.lineWidth=3;
    for(let i=1;i<3;i++){ const x=trackX+(trackW/3)*i; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke(); }
    ctx.setLineDash([]);
    // Move stripes to imply scrolling
    const stripeH=30, gap=60, scroll=(t*160)% (stripeH+gap);
    ctx.fillStyle='#d9dfff';
    for(let y=-stripeH;y<h;y+=stripeH+gap){
      ctx.fillRect(trackX+trackW/2-4, y+scroll, 8, stripeH);
    }
    // Player car pulsing
    const x = trackX + trackW/6 + Math.sin(t)*8;
    carSprite(ctx, x, h*0.75, '#ff3b6b');
  }
  function carSprite(ctx, cx, cy, bodyColor){
    const px = 3;                // pixel size for chunky style
    const w = 11, h = 17;        // sprite grid (approx 33x51 px)
    const x0 = Math.round(cx - (w*px)/2);
    const y0 = Math.round(cy - (h*px)/2);
    const wing = '#d9dfff';      // wings/accents
    const tyre = '#1a1a1a';      // tyres
    const cockpit = '#9ecaff';   // windshield
    const shadow = '#0f1730';    // subtle shadow/detail

    function rect(col, row, cw, rh, color){
      ctx.fillStyle = color;
      ctx.fillRect(x0 + col*px, y0 + row*px, cw*px, rh*px);
    }

    // Front wing (wide)
    rect(1, 0, 9, 1, wing);
    rect(2, 1, 7, 1, wing);

    // Nose
    rect(4, 1, 3, 3, bodyColor);

    // Cockpit + upper body
    rect(4, 4, 3, 1, bodyColor);
    rect(5, 4, 1, 1, cockpit);

    // Main body spine
    rect(4, 5, 3, 8, bodyColor);

    // Sidepod shading
    rect(3, 6, 1, 6, shadow);
    rect(7, 6, 1, 6, shadow);

    // Tyres (front)
    rect(1, 5, 2, 2, tyre);
    rect(8, 5, 2, 2, tyre);
    // Tyres (rear)
    rect(1, 10, 2, 2, tyre);
    rect(8, 10, 2, 2, tyre);

    // Engine cover/rear spine
    rect(4, 13, 3, 1, bodyColor);
    rect(4, 14, 3, 1, bodyColor);

    // Rear wing
    rect(2, 15, 7, 1, wing);
    rect(2, 16, 7, 1, wing);

    // Small highlight stripe down the center
    ctx.globalAlpha = 0.25;
    rect(5, 6, 1, 6, '#ffffff');
    ctx.globalAlpha = 1.0;
  }

  // ---------- Racing ----------
  function startRace(plan){
    const W = 520, H = 600;
    let gameOver=false;

    // Parameters influenced by upgrades:
    const topSpeed = 7.5 + save.upgrades.engine * 0.45;     // px per frame baseline
    const handling = 1.0 + save.upgrades.aero * 0.05;       // lane change smoothness & collision mitigation
    const pitSkill = Math.max(1.0 - save.upgrades.pitcrew*0.05, 0.55); // pit time multiplier

    const baseDrag = plan.weather.drag;
    const wet = plan.weather.wet;
    const tire = tireDefs[plan.tire];
    const tireOk = (wet>=tire.minWet) || (tire.minWet===0 && wet<0.3);
    let tireWear = 0; // 0..1
    let battery = 1;  // ERS 0..1
    let lap=1, position=12; // start P12
    let distance=0; // increases; a lap ~= 1000 units
    let pitReady=true, pitted=false, inPit=false, pitTimer=0;
    const lapDistance = 1000;
    const totalDistance = lapDistance * plan.laps;
    // Rival cars
    const rivals = [];
    const lanes = [W*0.1 + (W*0.8/6), W*0.1 + (W*0.8/2), W*0.1 + (W*0.8*5/6)];
    let laneIdx = 1, targetX = lanes[laneIdx];
    // Replace UI with live HUD (create first, then grab canvas)
    const hud = document.createElement('div');
    hud.className='card';
    hud.innerHTML = `
      <h1>Racing: <span class="pill">${plan.circuit.name}</span></h1>
      <div class="row">
        <div class="col">
          <canvas id="raceCanvas" width="${W}" height="${H}"></canvas>
          <p class="note">Laps ${lap}/${plan.laps} · Pos P<span id="pos">${position}</span> · Tire: <b>${plan.tire.toUpperCase()}</b> ${tireOk?'':'<span style="color:var(--warn)">(sub-optimal for weather)</span>'}</p>
          <div class="stat"><span>ERS</span><div class="progress"><div id="ersBar" class="bar" style="width:100%"></div></div></div>
          <div class="stat"><span>Tire Wear</span><div class="progress"><div id="wearBar" class="bar" style="width:0%;background:linear-gradient(90deg,#3ad17a,#ffd166,#ff7171)"></div></div></div>
          <p class="footer">Pit: press <span class="kbd">P</span> across the line when <span class="pill">PIT OPEN</span> shows. Avoid contact!</p>
        </div>
        <div class="col">
          <div class="tile"><h2>Telemetry</h2>
            <p>Speed: <b><span id="spd">0</span></b></p>
            <p>Lap Dist: <b><span id="lapd">0</span> / ${lapDistance}</b></p>
            <p>Total Dist: <b><span id="tDist">0</span> / ${totalDistance}</b></p>
            <p>Weather: <b>${plan.weather.name}</b></p>
          </div>
          <div class="tile">
            <button class="btn secondary" id="abort">Retire (DNF)</button>
          </div>
        </div>
      </div>`;
    $ui.innerHTML=''; $ui.appendChild(hud);

    // Canvas (must be selected after HUD is mounted)
    const cv = document.getElementById('raceCanvas');
    const ctx = cv.getContext('2d');

    const ersBar = document.getElementById('ersBar');
    const wearBar = document.getElementById('wearBar');
    const spdEl = document.getElementById('spd');
    const lapdEl = document.getElementById('lapd');
    const tDistEl = document.getElementById('tDist');
    const posEl = document.getElementById('pos');
    document.getElementById('abort').onclick = ()=>{ gameOver=true; finishRace(true); };

    // Input
    const keys = {};
    window.addEventListener('keydown', e=>{
      keys[e.key]=true;
      if(e.key==='ArrowLeft'){ laneIdx = Math.max(0, laneIdx-1); play('click'); }
      if(e.key==='ArrowRight'){ laneIdx = Math.min(2, laneIdx+1); play('click'); }
      if(e.key.toLowerCase()==='p' && pitReady && !inPit){ inPit=true; pitTimer = 120 * pitSkill; play('bump'); }
    });
    window.addEventListener('keyup', e=>{ keys[e.key]=false; });

    // Spawn rivals regularly
    let spawnTimer=0;
    function spawnRival(){
      const lane = Math.floor(Math.random()*3);
      const relY = -80; // appears ahead (moving downwards)
      const color = ['#3ad17a','#ffd166','#66e0ff','#ff9ce6'][Math.floor(Math.random()*4)];
      // Each rival has a baseSpeed slightly below/above you
      const base = topSpeed * (0.85 + Math.random()*0.2);
      rivals.push({ lane, x: lanes[lane], y: relY, spd: base, color });
    }

    // Loop
    let lastTs=performance.now();
    requestAnimationFrame(tick);

    function tick(ts){
      if(gameOver) return;
      const dt = Math.max(0.016, Math.min(0.040, (ts-lastTs)/1000)); // clamp
      lastTs = ts;
      update(dt);
      draw();
      requestAnimationFrame(tick);
    }

    function update(dt){
      targetX = lanes[laneIdx];
      // Tire wear
      tireWear = Math.min(1, tireWear + tire.wear * dt * (1 + (keys[' ']?0.8:0)) * (tireOk?1.0:1.6));
      // ERS
      if(keys[' '] && battery>0 && !inPit){ battery = Math.max(0, battery - 0.25*dt); } else {
        battery = Math.min(1, battery + 0.12*dt);
      }
      // Speed model
      let speed = topSpeed;
      speed *= plan.circuit.straights;
      speed *= baseDrag;
      speed *= tire.base * (1 - 0.45*tireWear); // worn tires slower
      if(keys[' '] && battery>0) speed *= 1.18; // ERS
      speed *= (0.98 + (save.upgrades.aero*0.004)); // aero small additive
      if(inPit){ speed = 2.2; }

      // Move player forward (distance)
      distance += speed * dt * 6; // scale factor to make progress per frame
      spdEl.textContent = Math.round(speed*28) + ' km/h';
      lapdEl.textContent = Math.floor(distance % lapDistance);
      tDistEl.textContent = Math.floor(distance);
      ersBar.style.width = Math.floor(battery*100)+'%';
      wearBar.style.width = Math.floor(tireWear*100)+'%';

      // Lap handling
      const prevLap = lap;
      lap = Math.min(plan.laps, Math.floor(distance / lapDistance) + 1);
      if(lap!==prevLap){ play('lap'); pitReady=true; }

      // Pit
      if(inPit){
        pitTimer -= dt*60;
        if(pitTimer<=0){
          inPit=false; pitted=true; tireWear=0;
          play('coin');
        }
      }

      // Rival spawns
      spawnTimer -= dt;
      if(spawnTimer<=0){
        spawnRival();
        spawnTimer = 0.7 + Math.random()*0.6;
      }
      // Update rivals (they move toward bottom; if pass, update position)
      for(const r of rivals){
        const relSpeed = speed - r.spd;
        r.y += (speed*dt*120) - (r.spd*dt*120*0.92);
        // Overtake detection: if you pass a rival (y increases down screen),
        // use lane and collision
      }
      // Collision & passing
      const carY = H*0.75;
      const curX = getPlayerX();
      for(const r of rivals){
        const dx = Math.abs(curX - r.x);
        const dy = Math.abs(carY - r.y);
        if(dy<46 && dx<26 && !inPit){
          // contact -> speed penalty and small knock
          play('bump');
          distance = Math.max(0, distance - 12);
          // Auto nudge if handling good
          if(handling>1.2){
            laneIdx = dx<0 ? Math.min(2, laneIdx+1) : Math.max(0, laneIdx-1);
          }
        }
        // If rival goes beyond your car, check pass
        if(r.y > carY+60 && !r.counted){
          r.counted = true;
          position = Math.max(1, position-1);
          posEl.textContent = position;
          play('overtake');
        }
      }
      // Cull rivals behind
      for(let i=rivals.length-1;i>=0;i--){
        if(rivals[i].y>H+80) rivals.splice(i,1);
      }

      // Finish
      if(distance>=totalDistance){
        gameOver=true;
        play('finish');
        finishRace(false);
      }
    }

    function getPlayerX(){
      const cv = document.getElementById('raceCanvas');
      const ctx = cv.getContext('2d');
      // Smooth move toward targetX based on handling
      if(!cv._px) cv._px = targetX;
      const k = Math.min(1, 0.12 * handling);
      cv._px = cv._px + (targetX - cv._px)*k;
      return cv._px;
    }

    function draw(){
      // Background track
      ctx.fillStyle='#0b0f1a'; ctx.fillRect(0,0,W,H);
      ctx.fillStyle='#111b33'; ctx.fillRect(W*0.1,0,W*0.8,H);
      // Center stripes scrolling per lap progress
      const stripeH=36, gap=64;
      const scroll=((distance*0.25)% (stripeH+gap));
      ctx.fillStyle='#d9dfff';
      for(let y=-stripeH;y<H;y+=stripeH+gap){
        ctx.fillRect(W*0.5-4, y+scroll, 8, stripeH);
      }
      // Lane dashed
      ctx.setLineDash([12,12]); ctx.strokeStyle='#4e5f95'; ctx.lineWidth=3;
      for(let i=1;i<3;i++){
        const x=W*0.1+(W*0.8/3)*i;
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke();
      }
      ctx.setLineDash([]);

      // Pit indicator
      if((distance % lapDistance) < 80 && !inPit){
        // pit open zone
        ctx.fillStyle='rgba(250, 219, 120, 0.18)';
        ctx.fillRect(0,0,W,26);
        ctx.fillStyle='#ffd166';
        ctx.font='700 14px system-ui';
        ctx.fillText('PIT OPEN — press P to pit', 12,18);
        pitReady=true;
      } else {
        pitReady=false;
      }

      // Rivals
      for(const r of rivals){
        carSprite(ctx, r.x, r.y, r.color);
      }
      // Player car
      carSprite(ctx, getPlayerX(), H*0.75, '#ff3b6b');

      // HUD overlay mini
      ctx.fillStyle='rgba(0,0,0,.25)'; ctx.fillRect(8,H-68, W-16, 60);
      ctx.fillStyle='#bcd0ff'; ctx.font='700 14px system-ui';
      ctx.fillText(`Lap ${lap}/${plan.laps}  •  P${position}`, 16, H-46);
      // ERS bar inline
      ctx.fillStyle='#6fa8ff'; ctx.fillRect(16, H-36, (W-32)*battery, 8);
      ctx.strokeStyle='#4a5a8e'; ctx.strokeRect(16, H-36, W-32, 8);
      // Wear bar
      ctx.fillStyle='#7af2ad'; ctx.fillRect(16, H-22, (W-32)*(1-tireWear), 6);
      ctx.fillStyle='#ff7171'; ctx.fillRect(16+(W-32)*(1-tireWear), H-22, (W-32)*tireWear, 6);
      ctx.strokeStyle='#4a5a8e'; ctx.strokeRect(16, H-22, W-32, 6);
    }

    function finishRace(retired){
      // Simple points: P1 25, P2 18, P3 15, 12, 10, 8, 6, 4, 2, 1, else 0
      const ptsTable=[25,18,15,12,10,8,6,4,2,1];
      let pos = retired? 'DNF' : `P${position}`;
      const pts = retired?0: (position<=10? ptsTable[position-1]:0);
      const prize = retired? 200 : Math.max(200, (12-position)*250);
      if(careerMode){
        save.races++;
        if(!retired){
          save.points += pts;
          if(position===1) save.wins++;
        }
        save.bank += prize;
        writeSave();
      }
      showResults({ retired, position, pts, prize, tire: plan.tire, laps: plan.laps, pitted, circuit: plan.circuit.name, weather: plan.weather.name });
    }
  }

  // ---------- Results ----------
  function showResults(res){
    render('tpl-results', ()=>{
      const grid = document.getElementById('resultGrid');
      grid.innerHTML = `
        <div class="tile"><h3>Position</h3><p class="big">${res.retired? 'DNF' : 'P'+res.position}</p></div>
        <div class="tile"><h3>Points</h3><p class="big">${res.pts}</p></div>
        <div class="tile"><h3>Prize</h3><p class="big money">${fmtMoney(res.prize)}</p></div>
        <div class="tile"><h3>Tire</h3><p class="big" style="font-size:28px">${res.tire.toUpperCase()}</p></div>
        <div class="tile"><h3>Pitted</h3><p class="big">${res.pitted? 'Yes' : 'No'}</p></div>
        <div class="tile"><h3>Circuit</h3><p class="big" style="font-size:22px">${res.circuit}</p></div>
        <div class="tile"><h3>Weather</h3><p class="big" style="font-size:22px">${res.weather}</p></div>
      `;
      document.getElementById('payout').textContent = 'Career earnings and points are saved automatically.';
      // Summary canvas
      const cv = document.getElementById('summaryCanvas'), ctx = cv.getContext('2d');
      ctx.fillStyle='#0b0f1a'; ctx.fillRect(0,0,cv.width,cv.height);
      ctx.fillStyle='#121a2b'; ctx.fillRect(0,0,cv.width,cv.height);
      // Simple celebratory banner
      ctx.fillStyle='#1b284a'; ctx.fillRect(0,cv.height-90,cv.width,90);
      ctx.fillStyle='#bcd0ff'; ctx.font='900 80px system-ui';
      ctx.fillText(res.retired?'DNF':('P'+res.position), 24, 110);
      ctx.fillStyle='#7af2ad'; ctx.font='700 24px system-ui';
      ctx.fillText(res.circuit + ' • ' + res.weather, 24, 150);
      // Trophy if podium
      if(!res.retired && res.position<=3){
        ctx.fillStyle=res.position===1?'#ffd166':(res.position===2?'#dfe3ee':'#c88a55');
        ctx.fillRect(340, 60, 40, 80);
        ctx.beginPath(); ctx.arc(360, 55, 18, 0, Math.PI*2); ctx.fill();
      }

      $ui.querySelector('[data-action="garage"]').onclick = ()=> openGarage();
      $ui.querySelector('[data-action="menu"]').onclick = ()=> openMenu();
      $ui.querySelector('[data-action="career"]').onclick = ()=> startCareerFlow();
    });
  }

  // ---------- Menu ----------
  function openMenu(){
    render('tpl-menu', ()=>{
      drawPreview();
      $ui.querySelector('[data-action="career"]').onclick = ()=> startCareerFlow();
      $ui.querySelector('[data-action="quick"]').onclick = ()=> quickRace();
      $ui.querySelector('[data-action="garage"]').onclick = ()=> openGarage();
    });
  }

  // ---------- Boot ----------
  openMenu();
})();
</script>
</body>
</html>
