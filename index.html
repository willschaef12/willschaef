<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Star Wars TD - Ultimate Attack + Specials</title>
<style>
  body {
    margin: 0;
    background: #000;
    color: #fff;
    font-family: 'Orbitron', sans-serif;
    overflow: hidden;
  }
  #ultimateScreen {
    position: fixed;
    top:0; left:0; width:100vw; height:100vh;
    background: #111;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  #ultimateScreen h1 {
    margin-bottom: 20px;
    font-size: 2.5em;
  }
  .ultimateButton {
    background: #222;
    border: 2px solid #555;
    padding: 20px 40px;
    margin: 10px;
    cursor: pointer;
    font-size: 1.2em;
    border-radius: 10px;
    width: 250px;
    text-align: center;
    color: #fff;
    user-select: none;
    transition: background 0.3s, border-color 0.3s;
  }
  .ultimateButton:hover {
    background: #444;
    border-color: cyan;
  }
  #game-container {
    display: flex;
    gap: 20px;
    margin-top: 20px;
    height: calc(100vh - 60px);
  }
  canvas {
    background-color: #111;
    border: 2px solid #fff;
    image-rendering: pixelated;
    flex-shrink: 0;
  }
  #battleCanvas {
    /* size set dynamically */
  }
  #uiPanel {
    width: 300px;
    background: #111;
    padding: 10px;
    border: 2px solid #fff;
    border-radius: 8px;
    overflow-y: auto;
    height: 100%;
    box-sizing: border-box;
  }
  button {
    width: 100%;
    margin: 5px 0;
    padding: 10px;
    font-weight: bold;
    background: #222;
    color: #fff;
    border: 1px solid #666;
    border-radius: 5px;
    cursor: pointer;
  }
  button:hover {
    background: #444;
  }
  #towerInfo {
    margin-top: 10px;
    background: #000;
    padding: 10px;
    border-radius: 6px;
    min-height: 200px;
  }
  h2 {
    margin-top: 0;
  }
  .upgrade-button {
    margin: 5px 0;
    padding: 6px;
    font-size: 0.9em;
    background: #333;
    border: 1px solid #555;
    cursor: pointer;
    border-radius: 4px;
  }
  .upgrade-button:disabled {
    background: #555;
    cursor: not-allowed;
  }
  #specialCooldown, #killsCounter, #baseHealth, #ultimateInfo {
    margin-top: 10px;
    font-weight: bold;
  }
  #ultimateInfo {
    font-size: 1.1em;
    color: cyan;
  }
</style>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet" />
</head>
<body>

<!-- Ultimate Attack Selection Screen -->
<div id="ultimateScreen">
  <h1>Select Your Ultimate Tower</h1>
  <div class="ultimateButton" data-tower="Stormtrooper Tower" style="color: white; border-color: white;">Stormtrooper Tower</div>
  <div class="ultimateButton" data-tower="Luke Skywalker Tower" style="color: limegreen; border-color: limegreen;">Luke Skywalker Tower</div>
  <div class="ultimateButton" data-tower="Darth Vader Tower" style="color: red; border-color: red;">Darth Vader Tower</div>
</div>

<h1 style="text-align:center; margin-top: 10px; color:#fff;">Star Wars Tower Defense</h1>

<div id="game-container" style="display:none;">
  <canvas id="battleCanvas"></canvas>

  <div id="uiPanel">
    <h2>Tower Shop</h2>
    <button id="btnStormtrooper">Stormtrooper Tower (Free)</button>
    <button id="btnLuke">Luke Skywalker Tower (200 credits)</button>
    <button id="btnDarth">Darth Vader Tower (300 credits)</button>
    <p><strong>Credits:</strong> <span id="credits">500</span></p>
    <p id="baseHealth"><strong>Base Health:</strong> 10</p>

    <div id="towerInfo">
      <h3>Tower Info</h3>
      <div id="towerDetails">Select a tower to see details here.</div>
      <div id="specialCooldown"></div>
      <div id="killsCounter"></div>
      <div id="ultimateInfo"></div>
      <div id="upgradeSection" style="display:none;">
        <h4>Upgrade Paths</h4>
        <div id="upgrades"></div>
      </div>
    </div>
  </div>
</div>

<script>
// --- Constants ---
const TOWER_MIN_DISTANCE_FROM_PATH = 40;

// --- Variables ---
const ultimateScreen = document.getElementById('ultimateScreen');
const ultimateButtons = document.querySelectorAll('.ultimateButton');
const gameContainer = document.getElementById('game-container');

const canvas = document.getElementById('battleCanvas');
const ctx = canvas.getContext('2d');
const creditsDisplay = document.getElementById('credits');
const towerDetails = document.getElementById('towerDetails');
const upgradeSection = document.getElementById('upgradeSection');
const upgradesDiv = document.getElementById('upgrades');
const specialCooldownDisplay = document.getElementById('specialCooldown');
const killsCounter = document.getElementById('killsCounter');
const baseHealthDisplay = document.getElementById('baseHealth');
const ultimateInfoDisplay = document.getElementById('ultimateInfo');

let credits = 500;
let baseHealth = 10;
let towers = [];
let enemies = [];
let selectedTower = null;
let enemySpawnTimer = 0;
let waveNumber = 1;
let path = [];
let gameRunning = false;
let placingTowerType = null;

let ultimateTowerName = null;
let ultimateKillsRequired = 5;

// --- Setup Canvas Size ---
function resizeCanvas() {
  canvas.width = window.innerWidth - 320; // reserve sidebar width
  canvas.height = window.innerHeight - 130; // reserve some top space + header
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// --- Define Path for enemies ---
function definePath() {
  path = [
    {x: 0, y: canvas.height / 2},
    {x: canvas.width * 0.25, y: canvas.height / 2},
    {x: canvas.width * 0.25, y: canvas.height * 0.8},
    {x: canvas.width * 0.75, y: canvas.height * 0.8},
    {x: canvas.width * 0.75, y: canvas.height * 0.25},
    {x: canvas.width, y: canvas.height * 0.25}
  ];
}

// --- Tower Class ---
class Tower {
  constructor(name, x, y, cost, color) {
    this.name = name;
    this.x = x;
    this.y = y;
    this.cost = cost;
    this.color = color;
    this.range = 120;
    this.fireRate = 1000;
    this.damage = 10;
    this.lastShot = 0;

    this.specialCooldown = 10000;
    this.lastSpecial = 0;

    this.upgradePaths = {
      damage: 0,
      range: 0,
      fireRate: 0,
    };

    this.kills = 0;
  }

  draw() {
    ctx.fillStyle = this.color;
    ctx.beginPath();
    ctx.arc(this.x, this.y, 30, 0, Math.PI * 2);
    ctx.fill();

    ctx.lineWidth = 4;
    ctx.strokeStyle = 'yellow';
    ctx.beginPath();
    ctx.arc(this.x, this.y, 32, 0, Math.PI * 2);
    ctx.stroke();

    if (selectedTower === this) {
      ctx.strokeStyle = 'cyan';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.range, 0, Math.PI * 2);
      ctx.stroke();
    }
  }

  canShoot() {
    return Date.now() - this.lastShot >= this.fireRate;
  }

  shoot(enemy) {
    enemy.health -= this.damage;
    this.lastShot = Date.now();
  }

  isEnemyInRange(enemy) {
    const dx = enemy.x - this.x;
    const dy = enemy.y - this.y;
    return Math.sqrt(dx*dx + dy*dy) <= this.range;
  }

  canUseSpecial() {
    return Date.now() - this.lastSpecial >= this.specialCooldown;
  }

  useSpecial() {
    this.lastSpecial = Date.now();

    if(this.name === 'Stormtrooper Tower') {
      enemies.forEach(enemy => {
        if(this.isEnemyInRange(enemy)) {
          enemy.health -= this.damage * 3;
        }
      });
    } else if(this.name === 'Luke Skywalker Tower') {
      let hitCount = 0;
      for(let enemy of enemies) {
        if(this.isEnemyInRange(enemy)) {
          enemy.health -= this.damage * 5;
          hitCount++;
          if(hitCount >= 3) break;
        }
      }
    } else if(this.name === 'Darth Vader Tower') {
      enemies.forEach(enemy => {
        if(this.isEnemyInRange(enemy)) {
          enemy.health -= this.damage * 4;
          enemy.currentPoint = Math.max(0, enemy.currentPoint - 1);
          const pos = enemy.path[enemy.currentPoint];
          enemy.x = pos.x;
          enemy.y = pos.y;
        }
      });
    }
  }

  getSpecialCooldownRemaining() {
    const remaining = this.specialCooldown - (Date.now() - this.lastSpecial);
    return remaining > 0 ? remaining : 0;
  }

  upgrade(path) {
    if (this.upgradePaths[path] < 3) {
      const cost = 100 * (this.upgradePaths[path] + 1);
      if (credits >= cost) {
        credits -= cost;
        this.upgradePaths[path]++;
        switch(path) {
          case 'damage': this.damage += 5; break;
          case 'range': this.range += 20; break;
          case 'fireRate': this.fireRate = Math.max(300, this.fireRate - 200); break;
        }
        updateCredits();
        updateTowerInfo(this);
        updateUpgradeButtons();
      } else {
        alert('Not enough credits to upgrade!');
      }
    }
  }
}

// --- Enemy Class ---
class Enemy {
  constructor(path) {
    this.path = path;
    this.currentPoint = 0;
    this.x = path[0].x;
    this.y = path[0].y;
    this.speed = 1.5;
    this.health = 30 + waveNumber * 10;
    this.maxHealth = this.health;
    this.radius = 15;
  }

  move() {
    if(this.currentPoint >= this.path.length - 1) return;

    const target = this.path[this.currentPoint + 1];
    const dx = target.x - this.x;
    const dy = target.y - this.y;
    const dist = Math.sqrt(dx*dx + dy*dy);

    if(dist < this.speed) {
      this.x = target.x;
      this.y = target.y;
      this.currentPoint++;
    } else {
      this.x += (dx / dist) * this.speed;
      this.y += (dy / dist) * this.speed;
    }
  }

  draw() {
    ctx.fillStyle = 'red';
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = 'black';
    ctx.fillRect(this.x - 20, this.y - 25, 40, 6);
    ctx.fillStyle = 'lime';
    ctx.fillRect(this.x - 20, this.y - 25, 40 * (this.health / this.maxHealth), 6);
    ctx.strokeStyle = 'white';
    ctx.strokeRect(this.x - 20, this.y - 25, 40, 6);
  }
}

// --- Helper Functions ---
function updateCredits() {
  creditsDisplay.textContent = credits;
}

function updateBaseHealth() {
  baseHealthDisplay.textContent = `Base Health: ${baseHealth}`;
}

function updateTowerInfo(tower) {
  selectedTower = tower;
  upgradeSection.style.display = 'block';

  towerDetails.innerHTML = `
    <p><strong>Name:</strong> ${tower.name}</p>
    <p><strong>Damage:</strong> ${tower.damage}</p>
    <p><strong>Range:</strong> ${tower.range}</p>
    <p><strong>Fire Rate (ms):</strong> ${tower.fireRate}</p>
  `;

  updateSpecialCooldown(tower);
  updateKillsCounter();
  updateUltimateInfo();
}

function updateSpecialCooldown(tower) {
  if(!tower) {
    specialCooldownDisplay.textContent = '';
    return;
  }
  let remaining = tower.getSpecialCooldownRemaining();
  if(remaining > 0) {
    specialCooldownDisplay.textContent = `Special attack ready in ${(remaining/1000).toFixed(1)} seconds`;
  } else {
    specialCooldownDisplay.textContent = `Special attack READY!`;
  }
}

function updateKillsCounter() {
  if(!selectedTower) {
    killsCounter.textContent = '';
    return;
  }
  killsCounter.textContent = `Kills: ${selectedTower.kills}`;
}

function updateUltimateInfo() {
  if(!selectedTower) {
    ultimateInfoDisplay.textContent = '';
    return;
  }
  if(selectedTower.name === ultimateTowerName) {
    let killsNeeded = ultimateKillsRequired - selectedTower.kills;
    if(killsNeeded <= 0) {
      ultimateInfoDisplay.textContent = `Ultimate Attack READY! Press "U" to unleash!`;
    } else {
      ultimateInfoDisplay.textContent = `Ultimate kills needed: ${killsNeeded}`;
    }
  } else {
    ultimateInfoDisplay.textContent = '';
  }
}

function updateUpgradeButtons() {
  upgradesDiv.innerHTML = '';
  if (!selectedTower) return;

  createUpgradeButton('damage', 'Increase Damage', selectedTower.upgradePaths.damage);
  createUpgradeButton('range', 'Increase Range', selectedTower.upgradePaths.range);
  createUpgradeButton('fireRate', 'Increase Fire Rate', selectedTower.upgradePaths.fireRate);
}

function createUpgradeButton(path, label, level) {
  const btn = document.createElement('button');
  btn.textContent = `${label} (Level ${level}/3) - Cost: ${100*(level+1)} credits`;
  btn.className = 'upgrade-button';
  if(level >= 3) {
    btn.disabled = true;
    btn.textContent = `${label} (MAX)`;
  }
  btn.onclick = () => {
    if(selectedTower) selectedTower.upgrade(path);
  }
  upgradesDiv.appendChild(btn);
}

function pointToSegmentDistance(px, py, x1, y1, x2, y2) {
  const l2 = (x2 - x1)**2 + (y2 - y1)**2;
  if(l2 === 0) return Math.sqrt((px - x1)**2 + (py - y1)**2);
  let t = ((px - x1)*(x2 - x1) + (py - y1)*(y2 - y1)) / l2;
  t = Math.max(0, Math.min(1, t));
  const projX = x1 + t*(x2 - x1);
  const projY = y1 + t*(y2 - y1);
  return Math.sqrt((px - projX)**2 + (py - projY)**2);
}

function placeTower(towerType, position) {
  for(let tower of towers) {
    const dx = tower.x - position.x;
    const dy = tower.y - position.y;
    if(Math.sqrt(dx*dx + dy*dy) < 60) {
      alert("Too close to another tower!");
      return false;
    }
  }
  for(let i=0; i<path.length - 1; i++) {
    let distToPath = pointToSegmentDistance(position.x, position.y,
      path[i].x, path[i].y,
      path[i+1].x, path[i+1].y
    );
    if(distToPath < TOWER_MIN_DISTANCE_FROM_PATH) {
      alert("Cannot place towers too close to the enemy path!");
      return false;
    }
  }
  if(towerType.cost > credits) {
    alert("Not enough credits!");
    return false;
  }
  credits -= towerType.cost;
  updateCredits();

  const newTower = new Tower(towerType.name, position.x, position.y, towerType.cost, towerType.color);
  towers.push(newTower);
  console.log(`Placed ${towerType.name} at (${position.x.toFixed(1)}, ${position.y.toFixed(1)})`);
  updateTowerInfo(newTower);
  updateUpgradeButtons();
  return true;
}

// --- Spawn Enemies ---
function spawnEnemy() {
  enemies.push(new Enemy(path));
}

// --- Ultimate Attack Animation ---
let ultimateActive = false;
let ultimateFrame = 0;
const ultimateFramesMax = 60;
function drawUltimateAnimation(tower) {
  if(!ultimateActive) return;
  ctx.save();
  ctx.globalAlpha = 1 - (ultimateFrame / ultimateFramesMax);
  ctx.strokeStyle = tower.color;
  ctx.lineWidth = 6;
  ctx.beginPath();
  ctx.arc(tower.x, tower.y, 40 + ultimateFrame*3, 0, Math.PI * 2);
  ctx.stroke();
  ctx.restore();

  ultimateFrame++;
  if(ultimateFrame > ultimateFramesMax) {
    ultimateActive = false;
    ultimateFrame = 0;
  }
}

// --- Activate Ultimate Attack ---
function activateUltimate(tower) {
  if(tower.kills < ultimateKillsRequired) {
    alert("Ultimate attack not ready yet!");
    return;
  }
  ultimateActive = true;
  ultimateFrame = 0;
  tower.kills = 0;
  ultimateKillsRequired += 5; // Increase kills needed next time
  alert(`${tower.name} unleashed their ULTIMATE ATTACK!`);

  // Effect of ultimate attack (example: big damage to all enemies)
  enemies.forEach(enemy => {
    if(tower.isEnemyInRange(enemy)) {
      enemy.health -= tower.damage * 10; // big damage
    }
  });
  updateUltimateInfo();
  updateKillsCounter();
}

// --- Game Loop ---
function gameLoop() {
  if(!gameRunning) return;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Draw path
  ctx.strokeStyle = '#444';
  ctx.lineWidth = 8;
  ctx.beginPath();
  ctx.moveTo(path[0].x, path[0].y);
  for(let i=1; i<path.length; i++) {
    ctx.lineTo(path[i].x, path[i].y);
  }
  ctx.stroke();

  // Move and draw enemies
  for(let i = enemies.length - 1; i >= 0; i--) {
    let enemy = enemies[i];
    enemy.move();
    enemy.draw();
    if(enemy.health <= 0) {
      enemies.splice(i, 1);
      credits += 20;
      updateCredits();
      if(selectedTower && selectedTower.name === ultimateTowerName) {
        selectedTower.kills++;
        updateKillsCounter();
        updateUltimateInfo();
      }
    } else if(enemy.currentPoint >= path.length - 1) {
      enemies.splice(i, 1);
      baseHealth--;
      updateBaseHealth();
      if(baseHealth <= 0) {
        alert("Game Over! Your base was destroyed.");
        gameRunning = false;
      }
    }
  }

  // Towers draw, shoot, and special attack
  for(let tower of towers) {
    tower.draw();

    if(tower.canUseSpecial()) {
      tower.useSpecial();
      if(selectedTower === tower) updateSpecialCooldown(tower);
    }

    if(tower.canShoot()) {
      let target = enemies.find(e => tower.isEnemyInRange(e));
      if(target) {
        tower.shoot(target);
        ctx.strokeStyle = 'yellow';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(tower.x, tower.y);
        ctx.lineTo(target.x, target.y);
        ctx.stroke();
      }
    }
  }

  // Draw ultimate animation if active
  if(ultimateActive && selectedTower) {
    drawUltimateAnimation(selectedTower);
  }

  // Update UI
  if(selectedTower) {
    updateSpecialCooldown(selectedTower);
    updateKillsCounter();
    updateUltimateInfo();
  }

  enemySpawnTimer += 16;
  if(enemySpawnTimer > 2000) {
    if(enemies.length < waveNumber * 5) {
      spawnEnemy();
    } else if(enemies.length === 0) {
      waveNumber++;
      alert(`Wave ${waveNumber - 1} finished! Prepare for wave ${waveNumber}`);
    }
    enemySpawnTimer = 0;
  }

  requestAnimationFrame(gameLoop);
}

// --- Event Listeners ---

// Tower shop buttons
document.getElementById('btnStormtrooper').onclick = () => {
  placingTowerType = {name:'Stormtrooper Tower', cost:0, color:'white'};
};
document.getElementById('btnLuke').onclick = () => {
  placingTowerType = {name:'Luke Skywalker Tower', cost:200, color:'limegreen'};
};
document.getElementById('btnDarth').onclick = () => {
  placingTowerType = {name:'Darth Vader Tower', cost:300, color:'red'};
};

// Canvas click for placing/selecting towers
canvas.addEventListener('click', (e) => {
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;

  // Place tower if selecting one
  if(placingTowerType) {
    if(placeTower(placingTowerType, {x: mouseX, y: mouseY})) {
      placingTowerType = null;
    }
    return;
  }

  // Select tower by clicking on it
  selectedTower = null;
  for(let tower of towers) {
    if(mouseX >= tower.x - 30 && mouseX <= tower.x + 30 &&
       mouseY >= tower.y - 30 && mouseY <= tower.y + 30) {
      selectedTower = tower;
      updateTowerInfo(tower);
      updateUpgradeButtons();
      return;
    }
  }

  // Click empty space, deselect
  selectedTower = null;
  towerDetails.textContent = "Select a tower to see details here.";
  upgradeSection.style.display = 'none';
  specialCooldownDisplay.textContent = '';
  killsCounter.textContent = '';
  ultimateInfoDisplay.textContent = '';
});

// Keyboard listener for Ultimate Attack activation
window.addEventListener('keydown', (e) => {
  if(e.key.toLowerCase() === 'u') {
    if(selectedTower && selectedTower.name === ultimateTowerName) {
      activateUltimate(selectedTower);
    }
  }
});

// Ultimate tower selection screen buttons
ultimateButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    ultimateTowerName = btn.dataset.tower;
    alert(`You chose ${ultimateTowerName} for your Ultimate Attack!\nUltimate requires ${ultimateKillsRequired} kills to activate.`);
    ultimateScreen.style.display = 'none';
    gameContainer.style.display = 'flex';
    gameRunning = true;
    initGame();
  });
});

// --- Initialize Game ---
function initGame() {
  definePath();
  updateCredits();
  updateBaseHealth();
  gameLoop();
}

</script>

</body>
</html>
